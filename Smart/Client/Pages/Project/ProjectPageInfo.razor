@page "/project/{ProjectId}"
@using Smart.Shared.DTOs.ProjectDTO
@using Smart.Shared.DTOs.TaskDTO
@using System.Net.Http.Headers
@inject HttpClient HttpClient
@inject NavigationManager NavigationManager

<RadzenContent Container="main">
    <RadzenHeading Size="H2" Text="@project.Name" />
    @* <RadzenText TextStyle="TextStyle.Subtitle1">@project.Description</RadzenText> *@

        <RadzenButton Text="New Task" Icon="add_circle_outline" Click="@OpenNewTaskDialog" />

        <RadzenDataGrid @ref="tasksGrid" Data="@tasks" AllowPaging="true" PageSize="10" AllowSorting="true">
            <Columns>
                <RadzenDataGridColumn TItem="WorkItemInfoDTO" Property="Name" Title="Name" />
                <RadzenDataGridColumn TItem="WorkItemInfoDTO" Property="Description" Title="Description" />
                <RadzenDataGridColumn TItem="WorkItemInfoDTO" Property="DueDate" Title="Due Date" />
                <RadzenDataGridColumn TItem="WorkItemInfoDTO" Property="Priority" Title="Priority" />
                <RadzenDataGridColumn TItem="WorkItemInfoDTO" Context="task" Bubble="false">
                    <Template>
                        <RadzenButton Icon="launch" Text="View Details" Click="@(() => NavigateToTaskPage(task.WorkItemId))" />
                    </Template>
                </RadzenDataGridColumn>
            </Columns>
        </RadzenDataGrid>

        <RadzenIcon Icon="chat" Style="position: fixed; bottom: 20px; right: 20px;" Click="@OpenChatDialog" />
    </RadzenContent>

    <RadzenDialog @bind-Value="@newTaskDialogOpen" Width="600px">
        <!-- Task creation form -->
    </RadzenDialog>

    <RadzenDialog @bind-Value="@chatDialogOpen" Width="600px">
        <!-- Project chat -->
    </RadzenDialog>

    <RadzenDialog @bind-Value="@inviteDialogOpen" Width="600px">
        <!-- Invite user form -->
    </RadzenDialog>

    @code {
    [Parameter]
    public int ProjectId { get; set; }

    private ProjectInfoDTO project = new ProjectInfoDTO();
    private List<WorkItemInfoDTO> tasks = new List<WorkItemInfoDTO>();
    private RadzenDataGrid<WorkItemInfoDTO>? tasksGrid;

    private bool newTaskDialogOpen = false;
    private bool chatDialogOpen = false;
    private bool inviteDialogOpen = false;

    protected override async Task OnInitializedAsync()
    {
        // Отримати деталі проекту від контролера
        project = await HttpClient.GetFromJsonAsync<ProjectInfoDTO>($"api/project/details/{ProjectId}");

        // Отримати список завдань для проекту від контролера
        // tasks = await HttpClient.GetFromJsonAsync<List<ProjectInfoDTO>>($"api/workitem/project/{ProjectId}");
    }

    private void NavigateToTaskPage(int workItemId)
    {
        NavigationManager.NavigateTo($"/task/{workItemId}");
    }

    private void OpenNewTaskDialog()
    {
        newTaskDialogOpen = true;
    }

    private void OpenChatDialog()
    {
        chatDialogOpen = true;
    }

    private void OpenInviteDialog()
    {
        inviteDialogOpen = true;
    }
}